<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Solution method · CFMMRouter.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link rel="canonical" href="https://bcc-research.github.io/CFMMRouter.jl/method/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">CFMMRouter.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Solution method</a><ul class="internal"><li><a class="tocitem" href="#Overview"><span>Overview</span></a></li><li><a class="tocitem" href="#Partial-dualization-of-the-constraints"><span>Partial dualization of the constraints</span></a></li><li><a class="tocitem" href="#Minimizing-the-dual-problem"><span>Minimizing the dual problem</span></a></li><li><a class="tocitem" href="#Extensions-and-notes"><span>Extensions and notes</span></a></li><li><a class="tocitem" href="#References"><span>References</span></a></li></ul></li><li><a class="tocitem" href="../objective/">Specifying objectives</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../examples/Univ3/">Uniswap V3 Router</a></li><li><a class="tocitem" href="../examples/arbitrage/">Arbitrage</a></li><li><a class="tocitem" href="../examples/liquidate/">Liquidating a basket of tokens</a></li></ul></li><li><a class="tocitem" href="../api/">API reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Solution method</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Solution method</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/bcc-research/CFMMRouter.jl/blob/main/docs/src/method.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Solution-method"><a class="docs-heading-anchor" href="#Solution-method">Solution method</a><a id="Solution-method-1"></a><a class="docs-heading-anchor-permalink" href="#Solution-method" title="Permalink"></a></h1><p>Here we describe our algorithmic approach to solve the routing problem</p><p class="math-container">\[\begin{array}{ll}
\text{maximize}     &amp; U(\Psi) \\
\text{subject to}   &amp; \Psi = \sum_{i=1}^m A_i(\Lambda_i - \Delta_i) \\
&amp; \phi_i(R_i + \gamma_i\Delta_i - \Lambda_i) = \phi_i(R_i), \quad i = 1, \dots, m \\
&amp;\Delta_i \geq 0, \quad \Lambda_i \geq 0, \quad i = 1, \dots, m.
\end{array}\]</p><h2 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h2><p>Our approach is a common one in large scale optimization: we decompose the problem such that the optimal trade on each individual CFMM can be solved independently. It is easy to see that the only constraint coupling the CFMM trades together is</p><p class="math-container">\[\Psi = \sum_{i=1}^m A_i(\Lambda_i - \Delta_i).\]</p><p>Therefore, if we can eliminate this constraint, the subproblems can be solved independently. Intuitively, our approach is to relax this constraint to be a penalty in the objective, where there is some cost of violation. If we fix these costs at a given round, the CFMM subproblems can be solved independently. We then use these subproblem solutions to update the cost of violation and iterate this process. The algorithmic details are explained below.</p><h2 id="Partial-dualization-of-the-constraints"><a class="docs-heading-anchor" href="#Partial-dualization-of-the-constraints">Partial dualization of the constraints</a><a id="Partial-dualization-of-the-constraints-1"></a><a class="docs-heading-anchor-permalink" href="#Partial-dualization-of-the-constraints" title="Permalink"></a></h2><p>Motivated by the insight above, we form the (partial) Lagrangian</p><p class="math-container">\[\mathcal{L}(\Psi, \Delta, \Lambda, \nu) = U(\Psi) -
\nu^T(\Psi - \sum_{i=1}^m A_i(\Lambda_i - \Delta_i)) -
\sum_{i=1}^m \mathbf{I}_i(\Delta_i, \Lambda_i),\]</p><p>where <span>$\nu$</span> is a dual variable and </p><p class="math-container">\[\mathbf{I}_i(\Delta_i, \Lambda_i) =
\begin{cases}
0 &amp; \Delta_i, \Lambda_i \geq 0, \text{ and } \phi_i(R_i + \gamma_i\Delta_i - \Lambda_i) \geq \phi(R_i) \\
\infty &amp; \text{otherwise}.
\end{cases}\]</p><p>In other words <span>$I_i$</span> is an indicator function which is 0 if the trade <span>$(\Delta_i, \Lambda_i)$</span> satisfies the CFMM&#39;s constraints and is positive infinity otherwise.</p><p>Notice that we only introduce a dual variable for the coupling constraint. The corresponding dual function, found by minimization over the primal variables, is</p><p class="math-container">\[\begin{aligned}
g(\nu) &amp;= \sup_{\Psi, \Delta_i, \Lambda_i} \mathcal{L}(\Psi, \Delta, \Lambda, \nu) \\
&amp;= \sup_\Psi \left(U(\Psi) -
\nu^T\Psi\right) + \sum_{i=1}^m \sup_{\Delta_i, \Lambda_i}\left(
(A_i^T\nu)^T(\Lambda_i - \Delta_i) -\mathbf{I}_i(\Delta_i, \Lambda_i) \right) \\
&amp;= (-U)^*(-\nu) + \sum_{i=1}^m \mathbf{arb}_i(A^T\nu),
\end{aligned}\]</p><p>where <span>$\mathbf{arb}_i(A^T\nu)$</span> is the optimal arbitrage profit from CFMM <span>$i$</span> with external &quot;market prices&quot; <span>$A^T\nu$</span> and <span>$(-U)^*$</span> is the Fenchel conjugate of <span>$-U$</span>. The optimal arbitrage problem for each CFMM <span>$i$</span> can be solved in parallel as the problems are fully independent. This problem corresponds to the following convex optimization problem:</p><p class="math-container">\[\begin{array}{ll}
\text{maximize} &amp; (A_i^T\nu)^T(\Lambda_i - \Delta_i)\\
\text{subject to} &amp; \phi_i(R_i + \gamma_i\Delta_i - \Lambda_i) \geq \phi_i(R_i) \\
&amp;\Delta_i \geq 0, \quad \Lambda_i \geq 0.
\end{array}\]</p><p>The general arbitrage problem, for arbitrary, convex trading functions <span>$\phi$</span>, can be efficiently solved with standard techniques (<em>e.g.</em>, a primal-dual interior point method). On the other hand, for many common CFMMs (<em>e.g.</em>, Uniswap v2) this problem has a closed form solution (<em>c.f.</em>, Appendix A<sup class="footnote-reference"><a id="citeref-2" href="#footnote-2">[2]</a></sup>) which we exploit in our solver.</p><h2 id="Minimizing-the-dual-problem"><a class="docs-heading-anchor" href="#Minimizing-the-dual-problem">Minimizing the dual problem</a><a id="Minimizing-the-dual-problem-1"></a><a class="docs-heading-anchor-permalink" href="#Minimizing-the-dual-problem" title="Permalink"></a></h2><p>As a result of strong duality, minimizing <span>$g(\nu)$</span> is equivalent to solving the original problem in that the optimal values are equal. After optimizing <span>$g(\nu)$</span>, we can reconstruct the trade using the <span>$\Delta_i$</span>&#39;s and <span>$\Lambda_i$</span>&#39;s found in the sub problems.</p><p>To minimize <span>$g(\nu)$</span>, we use L-BFGS-B<sup class="footnote-reference"><a id="citeref-3" href="#footnote-3">[3]</a></sup>, which requires evaluation of <span>$g(\nu)$</span> and <span>$\nabla g(\nu)$</span>. Note that the gradient of the Fenchel conjugate <span>$\nabla f^*(y)$</span> is the <span>$x$</span> at which the supremum <span>$\sup_x (y^Tx - f(x))$</span> is attained (this may not be a unique point but instead be a set of points—called the subdifferential—in which case we simply choose any <span>$x$</span> in this set).</p><p>The gradient <span>$\nabla_\nu \mathbf{arb}_i(A_i^T\nu) = A_i (\Lambda_i^* - \Delta_i^*)$</span>, where <span>$\Lambda^*$</span> and <span>$\Delta_i^*$</span> are the optimal values associated with <span>$\mathbf{arb}_i(A_i^T\nu)$</span>. Thus,</p><p class="math-container">\[\begin{aligned}
\nabla g(\nu) &amp;= -\Psi^* + \sum_{i=1}^m A_i (\Lambda_i^* - \Delta_i^*).
\end{aligned}\]</p><p>By evaluating the function <span>$g(\nu)$</span>, we get the gradient essentially for free. </p><h2 id="Extensions-and-notes"><a class="docs-heading-anchor" href="#Extensions-and-notes">Extensions and notes</a><a id="Extensions-and-notes-1"></a><a class="docs-heading-anchor-permalink" href="#Extensions-and-notes" title="Permalink"></a></h2><p>In the near future, we will support user-created CFMMs as well, which are specified by the trading function <span>$\phi$</span>, its gradient <span>$\nabla \phi$</span>, and its Hessian <span>$\nabla^2\phi$</span>. The gradient and Hessian may be specified exactly or by using automatic differentiation tools such as <code>ForwardDiff.jl</code> <sup class="footnote-reference"><a id="citeref-4" href="#footnote-4">[4]</a></sup>. This method could be extended to include gas fees and uncertain transaction execution (probabalistic constraints).</p><p>When using this method with real-world data, numerical issues (caused by the magnitude of and order of magnitude differences between numbers) may need to be carefully addressed via appropriate scaling. Additionally, the dual decomposition technique used will not necessarily yield a feasible <span>$\Psi$</span> when the trading function <span>$\phi$</span> is not strictly concave <sup class="footnote-reference"><a id="citeref-5" href="#footnote-5">[5]</a></sup> (e.g., for a constant sum CFMM). In this case, extra care needs to be taken during implementation.</p><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-1"><a class="tag is-link" href="#citeref-1">1</a>G. Angeris, T. Chitra, A. Evans, S. Boyd (2021). <a href="https://angeris.github.io/papers/cfmm-routing.pdf">Optimal routing for constant function market makers</a>.</li><li class="footnote" id="footnote-2"><a class="tag is-link" href="#citeref-2">2</a>G. Angeris, H. T. Kao, R. Chiang, C. Noyes, T. Chitra (2019). <a href="https://angeris.github.io/papers/uniswap_analysis.pdf">An analysis of Uniswap markets</a>.</li><li class="footnote" id="footnote-3"><a class="tag is-link" href="#citeref-3">3</a>C. Zhu, H. R. Byrd, P. Lu, J. Nocedal (1997). <a href="http://users.iems.northwestern.edu/~nocedal/lbfgsb.html">L-BFGS-B</a>.</li><li class="footnote" id="footnote-4"><a class="tag is-link" href="#citeref-4">4</a>J. Revels, M. Lubin, T. Papamarkou (2016). <a href="https://arxiv.org/abs/1607.07892">Forward-mode automatic differentiation in Julia</a>.</li><li class="footnote" id="footnote-5"><a class="tag is-link" href="#citeref-5">5</a>S. Boyd, L. Xiao, A. Mutapcic, J. Mattingley (2015). <a href="https://web.stanford.edu/class/ee364b/lectures/decomposition_notes.pdf">Notes on Decomposition Methods</a></li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../objective/">Specifying objectives »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Wednesday 8 February 2023 01:09">Wednesday 8 February 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
